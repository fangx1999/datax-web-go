{{define "common/confirm_modal.tmpl"}}
<!-- 通用确认模态框组件
使用方式：
1. 在页面中包含此模板
2. 通过JavaScript调用 showConfirmModal() 函数

参数：
- title: 模态框标题
- message: 确认消息
- warning: 警告文本（可选）
- confirmText: 确认按钮文本
- confirmClass: 确认按钮样式类
- action: 表单提交的URL
- method: HTTP方法（默认POST）
-->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">
          <i class="bi bi-exclamation-triangle text-warning me-2"></i><span id="confirmModalTitle">确认操作</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="confirmModalMessage">确定要执行此操作吗？</p>
        <p class="text-muted small" id="confirmModalWarning" style="display: none;"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <form id="confirmForm" method="post" class="d-inline">
          <button type="submit" class="btn" id="confirmSubmitBtn">确认</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// 通用确认模态框函数
function showConfirmModal(options) {
  const {
    title = '确认操作',
    message = '确定要执行此操作吗？',
    warning = '',
    confirmText = '确认',
    confirmClass = 'btn-primary',
    action = '',
    method = 'POST',
    onConfirm = null
  } = options;
  
  // 更新模态框内容
  document.getElementById('confirmModalTitle').textContent = title;
  document.getElementById('confirmModalMessage').textContent = message;
  
  const warningElement = document.getElementById('confirmModalWarning');
  if (warning) {
    warningElement.textContent = warning;
    warningElement.style.display = 'block';
  } else {
    warningElement.style.display = 'none';
  }
  
  // 更新确认按钮
  const submitBtn = document.getElementById('confirmSubmitBtn');
  submitBtn.textContent = confirmText;
  submitBtn.className = `btn ${confirmClass}`;
  
  // 更新表单
  const form = document.getElementById('confirmForm');
  form.action = action;
  
  // 设置HTTP方法
  const methodInput = form.querySelector('input[name="_method"]');
  if (methodInput) {
    methodInput.value = method;
  } else if (method !== 'POST') {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = '_method';
    input.value = method;
    form.appendChild(input);
  }
  
  // 设置确认回调
  if (onConfirm) {
    form.onsubmit = function(e) {
      e.preventDefault();
      onConfirm();
    };
  } else {
    form.onsubmit = function(e) {
      e.preventDefault();
      // 使用AJAX提交表单
      const formData = new FormData(form);
      
      fetch(action, {
        method: method,
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showAlert(data.error, 'danger');
        } else {
          showAlert(data.message || '操作成功', 'success');
          // 如果有重定向URL，则跳转
          if (data.redirect) {
            setTimeout(() => {
              window.location.href = data.redirect;
            }, 1000);
          } else {
            // 否则刷新页面
            setTimeout(() => {
              location.reload();
            }, 1000);
          }
        }
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
        modal.hide();
      })
      .catch(error => {
        console.error('操作失败:', error);
        showAlert('操作失败', 'danger');
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
        modal.hide();
      });
    };
  }
  
  // 显示模态框
  const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
  modal.show();
}

// 快捷函数
function showDeleteConfirm(itemName, action, onConfirm = null, warningText = null) {
  showConfirmModal({
    title: '确认删除',
    message: `确定要删除 ${itemName} 吗？`,
    warning: warningText || '此操作不可撤销。',
    confirmText: '删除',
    confirmClass: 'btn-danger',
    action: action,
    method: 'DELETE',
    onConfirm: onConfirm
  });
}

function showToggleConfirm(itemName, action, isDisabled, onConfirm = null, warningText = null) {
  const actionText = isDisabled ? '启用' : '禁用';
  
  showConfirmModal({
    title: '确认操作',
    message: `确定要${actionText} ${itemName} 吗？`,
    warning: warningText,
    confirmText: actionText,
    confirmClass: isDisabled ? 'btn-success' : 'btn-warning',
    action: action,
    method: 'POST',
    onConfirm: onConfirm
  });
}

function showRunConfirm(itemName, action, onConfirm = null, warningText = null) {
  showConfirmModal({
    title: '确认执行',
    message: `确定要立即执行 ${itemName} 吗？`,
    warning: warningText || '此操作将立即执行。',
    confirmText: '执行',
    confirmClass: 'btn-success',
    action: action,
    method: 'POST',
    onConfirm: onConfirm
  });
}

</script>
{{end}}
