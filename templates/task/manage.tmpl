{{define "task/manage.tmpl"}}
{{template "header" .}}

<div class="page">
  <div class="toolbar">
    <h1 class="h1">ä»»åŠ¡ç®¡ç†</h1>
    <div class="controls">
      <a class="btn" href="/tasks">â† è¿”å›åˆ—è¡¨</a>
    </div>
  </div>

  <!-- ä»»åŠ¡ä¿¡æ¯å¡ç‰‡ -->
  <div class="card">
    <div class="card-header">
      <h3>ä»»åŠ¡ä¿¡æ¯</h3>
    </div>
    <div class="task-info">
      <div class="info-row">
        <div class="info-label">ä»»åŠ¡ID</div>
        <div class="info-value">{{.Task.ID}}</div>
      </div>
      <div class="info-row">
        <div class="info-label">ä»»åŠ¡åç§°</div>
        <div class="info-value">{{.Task.Name}}</div>
      </div>
      <div class="info-row">
        <div class="info-label">æ•°æ®æº</div>
        <div class="info-value">
          <span class="data-source-flow-inline">
            <span class="source-inline">{{.Task.Source}}</span>
            <span class="arrow-inline">â†’</span>
            <span class="target-inline">{{.Task.Target}}</span>
          </span>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">åˆ›å»ºæ—¶é—´</div>
        <div class="info-value">{{.Task.CreatedAt.Format "2006-01-02 15:04:05"}}</div>
      </div>
      <div class="info-row">
        <div class="info-label">æ›´æ–°æ—¶é—´</div>
        <div class="info-value">{{.Task.UpdatedAt.Format "2006-01-02 15:04:05"}}</div>
      </div>
    </div>
  </div>


  <!-- JSONé…ç½®å¡ç‰‡ -->
  <div class="card">
    <div class="card-header">
      <h3>DataX JSON é…ç½®</h3>
      <div class="card-actions">
        <button id="editJsonBtn" class="btn" onclick="toggleJsonEdit()">
          <span class="btn-icon">âœ</span>
          ç¼–è¾‘
        </button>
      </div>
    </div>
    <div class="json-container">
      <pre class="json" id="jsonDisplay">{{.Task.JsonConfig}}</pre>
      <div class="json-edit hidden" id="jsonEdit">
        <div class="json-edit-header">
          <span class="json-edit-tip">ğŸ’¡ æç¤ºï¼šä½¿ç”¨ Ctrl+S ä¿å­˜ï¼ŒEsc å–æ¶ˆç¼–è¾‘</span>
        </div>
        <textarea id="jsonTextarea" class="json-textarea" rows="20" placeholder="è¯·è¾“å…¥æœ‰æ•ˆçš„JSONé…ç½®...">{{.Task.JsonConfig}}</textarea>
        <div class="json-edit-actions">
          <button class="btn primary" onclick="saveJson()">
            <span class="btn-icon">ğŸ’¾</span>
            ä¿å­˜
          </button>
          <button class="btn" onclick="cancelJsonEdit()">
            <span class="btn-icon">âŒ</span>
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- JSONç¼–è¾‘è¡¨å•ï¼ˆéšè—ï¼‰ -->
  <form id="jsonEditForm" method="post" action="/tasks/{{.Task.ID}}" style="display:none">
    <input type="hidden" name="datax_json" id="hiddenJsonConfig">
  </form>

</div>

<script>
let isJsonEditing = false;

function toggleJsonEdit() {
  const editBtn = document.getElementById('editJsonBtn');
  const jsonDisplay = document.getElementById('jsonDisplay');
  const jsonEdit = document.getElementById('jsonEdit');
  const jsonTextarea = document.getElementById('jsonTextarea');
  
  if (!isJsonEditing) {
    // è¿›å…¥ç¼–è¾‘æ¨¡å¼
    editBtn.classList.add('hidden'); // éšè—å³ä¸Šè§’æŒ‰é’®
    jsonDisplay.classList.add('hidden');
    jsonEdit.classList.remove('hidden');
    
    // è®¾ç½®textareaçš„å€¼
    jsonTextarea.value = jsonDisplay.textContent;
    
    // è‡ªåŠ¨èšç„¦å¹¶é€‰ä¸­æ‰€æœ‰æ–‡æœ¬
    jsonTextarea.focus();
    jsonTextarea.select();
    
    isJsonEditing = true;
  } else {
    // å–æ¶ˆç¼–è¾‘
    cancelJsonEdit();
  }
}

function saveJson() {
  const jsonTextarea = document.getElementById('jsonTextarea');
  const jsonValue = jsonTextarea.value.trim();
  
  // è®¾ç½®éšè—è¡¨å•çš„å€¼
  document.getElementById('hiddenJsonConfig').value = jsonValue;
  
  // ä½¿ç”¨ç»Ÿä¸€çš„æ ¡éªŒå‡½æ•°
  const errors = validateForm(document.getElementById('jsonEditForm'), {
    datax_json: {
      required: true,
      minLength: 1,
      label: 'DataXé…ç½®'
    }
  });
  
  if (errors.length > 0) {
    showFormErrors(errors, document.getElementById('jsonEditForm'));
    return;
  }
  
  // JSONæ ¼å¼éªŒè¯
  try {
    JSON.parse(jsonValue);
  } catch (e) {
    alert('JSONæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥åé‡è¯•ï¼š\n' + e.message);
    return;
  }
  
  // æäº¤è¡¨å•
  document.getElementById('jsonEditForm').submit();
}

function cancelJsonEdit() {
  const editBtn = document.getElementById('editJsonBtn');
  const jsonDisplay = document.getElementById('jsonDisplay');
  const jsonEdit = document.getElementById('jsonEdit');
  const jsonTextarea = document.getElementById('jsonTextarea');
  
  // æ¢å¤åŸå§‹å€¼
  jsonTextarea.value = jsonDisplay.textContent;
  
  // é€€å‡ºç¼–è¾‘æ¨¡å¼
  editBtn.classList.remove('hidden'); // é‡æ–°æ˜¾ç¤ºå³ä¸Šè§’æŒ‰é’®
  editBtn.innerHTML = '<span class="btn-icon">âœ</span>ç¼–è¾‘';
  editBtn.className = 'btn';
  jsonDisplay.classList.remove('hidden');
  jsonEdit.classList.add('hidden');
  isJsonEditing = false;
}

// æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
document.addEventListener('keydown', function(e) {
  if (isJsonEditing) {
    // Ctrl+S ä¿å­˜
    if (e.ctrlKey && e.key === 's') {
      e.preventDefault();
      saveJson();
    }
    // Esc å–æ¶ˆ
    if (e.key === 'Escape') {
      e.preventDefault();
      cancelJsonEdit();
    }
  }
});
</script>

{{template "footer" .}}
{{end}}
